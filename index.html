import React, { useState, useEffect, useRef } from 'react';
import { Download, Play, RotateCcw, Copy, HelpCircle, Table as TableIcon, FileText } from 'lucide-react';

// 定義資料結構
interface SubItem {
  name: string;
  detail: string; // 第四欄：驗證方法
}

interface Category {
  name: string;
  items: SubItem[];
}

interface FishboneData {
  head: string;
  categories: Category[];
}

// 預設範例資料 (熱水器不熱)
const DEMO_DATA = `熱水器不熱	能源/電力因素	瓦斯桶沒氣了	檢查瓦斯錶或搖晃瓦斯桶
熱水器不熱	能源/電力因素	電池沒電 (點火聲弱)	更換全新的鹼性電池
熱水器不熱	能源/電力因素	天然氣總開關未開	檢查開關是否垂直開啟
熱水器不熱	設備/硬體因素	點火針積碳	用乾布輕擦點火針
熱水器不熱	設備/硬體因素	水盤皮膜破損	需請技師更換
熱水器不熱	設備/硬體因素	溫度調節鈕故障	旋轉測試火焰變化
熱水器不熱	水路/環境因素	水壓過大 (流速快)	關小進水閥
熱水器不熱	水路/環境因素	進水溫度太低	火力調大水量調小
熱水器不熱	水路/環境因素	熱水管路堵塞	檢查出水量
熱水器不熱	人為操作因素	混水龍頭冷水太多	轉至全熱水測試
熱水器不熱	人為操作因素	模式設定錯誤	檢查是否為冬天模式`;

const App = () => {
  const [inputText, setInputText] = useState(DEMO_DATA);
  const [fishboneData, setFishboneData] = useState<FishboneData | null>(null);
  const [showTablePreview, setShowTablePreview] = useState(true);
  const svgRef = useRef<SVGSVGElement>(null);

  // 解析 TSV (Tab Separated Values) 資料
  const parseData = (text: string) => {
    const lines = text.trim().split('\n');
    if (lines.length === 0) return null;

    let head = "問題點";
    const categoryMap = new Map<string, SubItem[]>();
    const rawRows: string[][] = [];

    lines.forEach(line => {
      // 處理 Excel 貼上的 Tab 分隔
      const cols = line.split('\t').map(c => c.trim()); // 不過濾空字串，保留結構
      if (cols.length === 0 || (cols.length === 1 && cols[0] === '')) return;
      
      rawRows.push(cols);

      if (cols.length > 0 && cols[0]) {
        // 第一欄是魚頭
        if (cols[0]) head = cols[0];
        
        // 第二欄是分類 (大骨)
        if (cols.length >= 2) {
          const catName = cols[1];
          const itemName = cols.length >= 3 ? cols[2] : "";
          const detailName = cols.length >= 4 ? cols[3] : "";

          if (catName) {
            if (!categoryMap.has(catName)) {
              categoryMap.set(catName, []);
            }

            if (itemName) {
              categoryMap.get(catName)?.push({ name: itemName, detail: detailName });
            }
          }
        }
      }
    });

    const categories: Category[] = [];
    categoryMap.forEach((items, name) => {
      categories.push({ name, items });
    });

    return { head, categories, rawRows };
  };

  useEffect(() => {
    const data = parseData(inputText);
    // 只更新 fishboneData 的部分
    if (data) {
        setFishboneData({ head: data.head, categories: data.categories });
    } else {
        setFishboneData(null);
    }
  }, [inputText]);

  // 取得解析後的表格資料用於預覽
  const parsedPreviewData = parseData(inputText)?.rawRows || [];

  // 下載 SVG 功能
  const downloadSVG = () => {
    if (!svgRef.current) return;
    const svgData = new XMLSerializer().serializeToString(svgRef.current);
    const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `魚骨圖_${fishboneData?.head || 'download'}.svg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // 繪製邏輯常數
  const CONFIG = {
    width: 1200, // 加寬畫布
    height: 700,
    spineY: 350,
    spineEnd: 900,
    spineStart: 50,
    headX: 950, // 魚頭位置
    categorySpacing: 180,
  };

  // 渲染魚骨圖
  const renderFishbone = () => {
    if (!fishboneData || fishboneData.categories.length === 0) {
      return (
        <text x="50%" y="50%" textAnchor="middle" className="text-gray-400 text-xl">
          請在左側輸入資料以產生圖表
        </text>
      );
    }

    const { categories, head } = fishboneData;
    const elements: JSX.Element[] = [];

    // 1. 畫主骨幹 (Spine)
    elements.push(
      <line 
        key="spine" 
        x1={CONFIG.spineStart} y1={CONFIG.spineY} 
        x2={CONFIG.headX} y2={CONFIG.spineY} 
        stroke="#334155" strokeWidth="4" 
        markerEnd="url(#arrowhead)"
      />
    );

    // 2. 畫魚頭 (Head)
    // 魚頭框框
    elements.push(
      <g key="head">
        <path
            d={`M ${CONFIG.headX + 5} ${CONFIG.spineY - 40} 
               L ${CONFIG.headX + 180} ${CONFIG.spineY - 40} 
               L ${CONFIG.headX + 220} ${CONFIG.spineY} 
               L ${CONFIG.headX + 180} ${CONFIG.spineY + 40} 
               L ${CONFIG.headX + 5} ${CONFIG.spineY + 40} 
               Z`}
            fill="#3b82f6" 
            stroke="#2563eb"
            strokeWidth="2"
            className="shadow-lg"
        />
        <text 
            x={CONFIG.headX + 100} 
            y={CONFIG.spineY} 
            fill="white" 
            fontSize="18" 
            fontWeight="bold" 
            textAnchor="middle"
            alignmentBaseline="middle"
            style={{ pointerEvents: 'none' }} 
        >
            {head}
        </text>
      </g>
    );

    // 3. 畫分類 (Categories) 和 原因 (Items)
    let currentX = CONFIG.headX - 150; 

    categories.forEach((cat, index) => {
      const isTop = index % 2 === 0;
      const startY = CONFIG.spineY;
      const endY = isTop ? startY - 180 : startY + 180;
      const boneEndX = currentX - 60; 

      // 畫大骨
      elements.push(
        <g key={`cat-group-${index}`}>
            <line 
                x1={currentX} y1={startY} 
                x2={boneEndX} y2={endY} 
                stroke="#475569" strokeWidth="3"
            />
            {/* 分類名稱框 */}
            <rect 
                x={boneEndX - 60} 
                y={isTop ? endY - 40 : endY} 
                width={120} 
                height={40} 
                rx={4}
                fill="#f1f5f9"
                stroke="#64748b"
                strokeWidth="2"
            />
            <text 
                x={boneEndX} 
                y={isTop ? endY - 15 : endY + 25} 
                textAnchor="middle" 
                fontWeight="bold"
                fill="#1e293b"
                fontSize="14"
            >
                {cat.name}
            </text>
        </g>
      );

      // 畫魚刺
      cat.items.forEach((item, i) => {
        const t = (i + 1) / (cat.items.length + 1);
        const itemRootX = currentX + (boneEndX - currentX) * t;
        const itemRootY = startY + (endY - startY) * t;
        
        const itemLineLength = 140;
        const itemEndX = isTop ? itemRootX + itemLineLength : itemRootX + itemLineLength;
        const itemEndY = itemRootY;

        elements.push(
            <g key={`item-${index}-${i}`}>
                <line 
                    x1={itemRootX} y1={itemRootY}
                    x2={itemEndX} y2={itemEndY}
                    stroke="#94a3b8" strokeWidth="2"
                />
                <text 
                    x={itemEndX + 5} 
                    y={itemEndY - 5} 
                    fontSize="13" 
                    fill="#334155"
                    fontWeight="500"
                >
                    {item.name}
                </text>
                {item.detail && (
                     <text 
                     x={itemEndX + 5} 
                     y={itemEndY + 12} 
                     fontSize="11" 
                     fill="#ef4444"
                 >
                     ({item.detail})
                 </text>
                )}
            </g>
        );
      });

      currentX -= CONFIG.categorySpacing;
    });

    return elements;
  };

  return (
    <div className="flex flex-col h-screen bg-gray-50 text-slate-800 font-sans">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm shrink-0">
        <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">魚</div>
            <h1 className="text-xl font-bold text-gray-800">Excel 轉 魚骨圖產生器</h1>
        </div>
        <div className="flex gap-3">
             <button 
                onClick={() => setInputText(DEMO_DATA)}
                className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 transition-colors"
            >
                <RotateCcw size={16} /> 載入範例
            </button>
            <button 
                onClick={downloadSVG}
                className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors shadow-sm"
            >
                <Download size={16} /> 下載 SVG
            </button>
        </div>
      </header>

      {/* Main Content */}
      <div className="flex flex-1 overflow-hidden">
        
        {/* Left Panel: Input */}
        <div className="w-1/3 min-w-[450px] bg-white border-r border-gray-200 flex flex-col shadow-lg z-10 flex-shrink-0">
            {/* Input Header */}
            <div className="p-4 bg-gray-50 border-b border-gray-200">
                <div className="flex justify-between items-center mb-2">
                    <h2 className="font-semibold text-gray-700 flex items-center gap-2">
                        <FileText size={18} /> 資料輸入
                    </h2>
                    <div className="text-xs text-gray-500 bg-yellow-50 px-2 py-1 rounded border border-yellow-200">
                        提示：請直接貼上 Excel 內容
                    </div>
                </div>
                
                {/* Visual Column Headers */}
                <div className="grid grid-cols-4 gap-2 text-xs font-bold text-gray-600 bg-gray-200 p-2 rounded-t-md mt-2">
                    <div className="text-center border-r border-gray-300">A欄: 問題(魚頭)</div>
                    <div className="text-center border-r border-gray-300">B欄: 主分類</div>
                    <div className="text-center border-r border-gray-300">C欄: 原因</div>
                    <div className="text-center">D欄: 驗證方法</div>
                </div>
            </div>

            {/* Input Area */}
            <div className="relative flex-1 flex flex-col min-h-[200px]">
                 <textarea
                    className="flex-1 p-4 w-full resize-none focus:outline-none focus:bg-blue-50/30 font-mono text-sm leading-6 text-gray-700 whitespace-pre"
                    placeholder="在此貼上您的 Excel 資料..."
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    style={{
                        backgroundImage: 'linear-gradient(transparent 23px, #e5e7eb 24px)',
                        backgroundSize: '100% 24px',
                        lineHeight: '24px',
                        backgroundAttachment: 'local'
                    }}
                />
            </div>

            {/* Table Preview Section (解決「沒有格線」的問題) */}
            <div className="border-t border-gray-300 bg-gray-50 flex flex-col h-1/3 min-h-[200px]">
                <div className="px-4 py-2 border-b border-gray-200 flex justify-between items-center bg-gray-100">
                     <h3 className="text-sm font-semibold text-gray-600 flex items-center gap-2">
                        <TableIcon size={14} /> 表格預覽 (確認電腦讀到的資料)
                    </h3>
                </div>
                <div className="overflow-auto p-0 flex-1">
                    <table className="w-full text-xs text-left border-collapse">
                        <thead className="bg-gray-100 sticky top-0">
                            <tr>
                                <th className="border border-gray-300 px-2 py-1 w-1/4">問題點 (魚頭)</th>
                                <th className="border border-gray-300 px-2 py-1 w-1/4">主分類 (大骨)</th>
                                <th className="border border-gray-300 px-2 py-1 w-1/4">原因 (魚刺)</th>
                                <th className="border border-gray-300 px-2 py-1 w-1/4">驗證方法</th>
                            </tr>
                        </thead>
                        <tbody>
                            {parsedPreviewData.map((row, idx) => (
                                <tr key={idx} className="bg-white even:bg-slate-50 hover:bg-blue-50">
                                    <td className="border border-gray-300 px-2 py-1 truncate max-w-[100px]">{row[0] || '-'}</td>
                                    <td className="border border-gray-300 px-2 py-1 truncate max-w-[100px]">{row[1] || '-'}</td>
                                    <td className="border border-gray-300 px-2 py-1 truncate max-w-[100px]">{row[2] || '-'}</td>
                                    <td className="border border-gray-300 px-2 py-1 truncate max-w-[100px] text-red-500">{row[3] || ''}</td>
                                </tr>
                            ))}
                            {parsedPreviewData.length === 0 && (
                                <tr>
                                    <td colSpan={4} className="text-center py-4 text-gray-400">目前沒有資料</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {/* Right Panel: Preview */}
        <div className="flex-1 bg-slate-200 overflow-auto flex items-center justify-center p-8 relative">
            <div className="bg-white rounded-xl shadow-xl border border-gray-300 overflow-hidden">
                <svg 
                    ref={svgRef}
                    width={CONFIG.width} 
                    height={CONFIG.height} 
                    viewBox={`0 0 ${CONFIG.width} ${CONFIG.height}`}
                    className="w-full h-full"
                    style={{ minWidth: '900px' }}
                >
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#334155" />
                        </marker>
                    </defs>
                    <rect width="100%" height="100%" fill="white" />
                    {renderFishbone()}
                </svg>
            </div>
            <div className="absolute bottom-6 right-8 text-xs text-slate-500 bg-white/80 px-2 py-1 rounded shadow">
                SVG 預覽 (1200 x 700)
            </div>
        </div>
      </div>
    </div>
  );
};

export default App;
